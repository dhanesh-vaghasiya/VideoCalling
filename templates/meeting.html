<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meeting â€“ {{ meeting_id }}</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #1a1a2e;
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* â”€â”€ Top bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 24px;
      background: rgba(0,0,0,.35);
    }
    .topbar .meeting-info { font-size: .9rem; color: #ccc; }
    .topbar .meeting-info span { color: #6c63ff; font-weight: 600; cursor: pointer; }
    #copyMsg { color: #4caf50; font-size: .8rem; margin-left: 8px; display: none; }

    /* â”€â”€ Video grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .video-grid {
      flex: 1;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      gap: 16px;
      padding: 24px;
      overflow-y: auto;
    }
    .video-tile {
      position: relative;
      background: #16213e;
      border-radius: 14px;
      overflow: hidden;
      width: 480px;
      max-width: 100%;
      aspect-ratio: 16/9;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 20px rgba(0,0,0,.5);
    }
    .video-tile video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 14px;
    }
    .video-tile .label {
      position: absolute;
      bottom: 10px;
      left: 14px;
      background: rgba(0,0,0,.55);
      padding: 4px 12px;
      border-radius: 8px;
      font-size: .85rem;
    }
    .video-tile .avatar {
      width: 80px; height: 80px;
      border-radius: 50%;
      background: #6c63ff;
      display: flex; align-items: center; justify-content: center;
      font-size: 2rem; font-weight: 700;
    }

    /* â”€â”€ Controls bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 18px;
      padding: 18px;
      background: rgba(0,0,0,.4);
    }
    .ctrl-btn {
      width: 56px; height: 56px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      font-size: 1.3rem;
      display: flex; align-items: center; justify-content: center;
      transition: background .2s, transform .1s;
      color: #fff;
    }
    .ctrl-btn:hover { transform: scale(1.08); }
    .ctrl-btn.on  { background: rgba(255,255,255,.15); }
    .ctrl-btn.off { background: #e74c3c; }
    .ctrl-btn.leave { background: #e74c3c; width: 72px; border-radius: 28px; font-size: 1rem; font-weight: 600; }
    .ctrl-btn.leave:hover { background: #c0392b; }

    /* â”€â”€ Share link box â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .share-box {
      background: rgba(108,99,255,.12);
      border: 1px dashed #6c63ff;
      border-radius: 10px;
      padding: 14px 20px;
      margin: 0 24px 12px;
      text-align: center;
      font-size: .9rem;
    }
    .share-box a { color: #6c63ff; word-break: break-all; }
  </style>
</head>
<body>

<!-- Top bar -->
<div class="topbar">
  <div>
    <strong>Video Call</strong>
  </div>
  <div class="meeting-info">
    Meeting ID:&nbsp;
    <span id="meetingIdLabel" title="Click to copy">{{ meeting_id }}</span>
    <span id="copyMsg">Copied!</span>
  </div>
</div>

<!-- Share link -->
<div class="share-box">
  Share this link so others can join:&nbsp;
  <a id="shareLink" href="#" target="_blank"></a>
</div>

<!-- Video grid (tiles get added here dynamically) -->
<div class="video-grid" id="videoGrid">
  <!-- local tile is created by JS -->
</div>

<!-- Controls -->
<div class="controls">
  <button class="ctrl-btn on" id="micBtn" title="Toggle Mic">ðŸŽ¤</button>
  <button class="ctrl-btn on" id="camBtn" title="Toggle Camera">ðŸ“·</button>
  <button class="ctrl-btn leave" id="leaveBtn" title="Leave">Leave</button>
</div>

<!-- VideoSDK JS SDK (browser bundle) -->
<script src="https://sdk.videosdk.live/js-sdk/0.1.6/videosdk.js"></script>

<script>
  // â”€â”€â”€ Config passed from Flask â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const TOKEN     = "{{ token }}";
  const MEETING_ID = "{{ meeting_id }}";
  const USER_NAME  = "{{ name }}";

  // â”€â”€â”€ Share link â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const shareUrl = `${location.origin}/join?meetingId=${MEETING_ID}&name=`;
  document.getElementById("shareLink").href = shareUrl;
  document.getElementById("shareLink").textContent = shareUrl;

  // Copy meeting ID on click
  document.getElementById("meetingIdLabel").addEventListener("click", () => {
    navigator.clipboard.writeText(MEETING_ID);
    const msg = document.getElementById("copyMsg");
    msg.style.display = "inline";
    setTimeout(() => msg.style.display = "none", 1500);
  });

  // â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let micOn = true;
  let camOn = true;
  let meeting;

  // â”€â”€â”€ Helper: create a video tile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function createTile(id, name, isLocal) {
    const tile = document.createElement("div");
    tile.className = "video-tile";
    tile.id = `tile-${id}`;

    // avatar (shown when cam off)
    const avatar = document.createElement("div");
    avatar.className = "avatar";
    avatar.id = `avatar-${id}`;
    avatar.textContent = (name || "?")[0].toUpperCase();
    tile.appendChild(avatar);

    // video element (hidden until stream added)
    const video = document.createElement("video");
    video.id = `video-${id}`;
    video.autoplay = true;
    video.playsInline = true;
    if (isLocal) video.muted = true;        // don't hear own echo
    video.style.display = "none";
    tile.appendChild(video);

    // label
    const label = document.createElement("div");
    label.className = "label";
    label.textContent = isLocal ? `${name} (You)` : name;
    tile.appendChild(label);

    document.getElementById("videoGrid").appendChild(tile);
    return tile;
  }

  function removeTile(id) {
    const tile = document.getElementById(`tile-${id}`);
    if (tile) tile.remove();
  }

  function setStream(id, stream, kind) {
    if (kind === "video") {
      const videoEl = document.getElementById(`video-${id}`);
      const avatarEl = document.getElementById(`avatar-${id}`);
      if (videoEl) {
      //alert("Video stream enabled for participant " + id);
        const mediaStream = new MediaStream();
        mediaStream.addTrack(stream.track);
        videoEl.srcObject = mediaStream;
        videoEl.style.display = "block";
      }
      if (avatarEl) avatarEl.style.display = "none";
    }
    // audio
    if (kind === "audio") {
      // For remote participants, play their audio
      let audioEl = document.getElementById(`audio-${id}`);
      if (!audioEl) {
        audioEl = document.createElement("audio");
        audioEl.id = `audio-${id}`;
        audioEl.autoplay = true;
        document.body.appendChild(audioEl);
      }
      const mediaStream = new MediaStream();
      mediaStream.addTrack(stream.track);
      audioEl.srcObject = mediaStream;
    }
  }

  function removeStream(id, kind) {
    if (kind === "video") {
      const videoEl = document.getElementById(`video-${id}`);
      const avatarEl = document.getElementById(`avatar-${id}`);
      if (videoEl) { videoEl.srcObject = null; videoEl.style.display = "none"; }
      if (avatarEl) avatarEl.style.display = "flex";
    }
    if (kind === "audio") {
      const audioEl = document.getElementById(`audio-${id}`);
      if (audioEl) { audioEl.srcObject = null; audioEl.remove(); }
    }
  }

  // â”€â”€â”€ Participant handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function handleParticipant(participant, isLocal) {
    createTile(participant.id, participant.displayName, isLocal);

    participant.on("stream-enabled", (stream) => {
      setStream(participant.id, stream, stream.kind);
    });

    participant.on("stream-disabled", (stream) => {
      removeStream(participant.id, stream.kind);
    });
  }

  // â”€â”€â”€ Init meeting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function startMeeting() {
    // Configure token globally FIRST (required by the SDK)
    VideoSDK.config(TOKEN);

    meeting = VideoSDK.initMeeting({
      meetingId: MEETING_ID,
      name: USER_NAME,
      micEnabled: true,
      webcamEnabled: true,
    });

    // Meeting joined
    meeting.on("meeting-joined", () => {
      console.log("Meeting joined!");
      // Handle local participant
      handleParticipant(meeting.localParticipant, true);
    });

    // Meeting left
    meeting.on("meeting-left", () => {
      console.log("Meeting left");
      document.getElementById("videoGrid").innerHTML =
        '<p style="color:#aaa;font-size:1.2rem;">You left the meeting.</p>';
    });

    // Remote participant joined
    meeting.on("participant-joined", (participant) => {
      console.log("Participant joined:", participant.displayName);
      handleParticipant(participant, false);
    });

    // Remote participant left
    meeting.on("participant-left", (participant) => {
      console.log("Participant left:", participant.displayName);
      removeTile(participant.id);
    });

    meeting.join();
  }

  // â”€â”€â”€ Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById("micBtn").addEventListener("click", () => {
    if (micOn) { meeting.muteMic(); } else { meeting.unmuteMic(); }
    micOn = !micOn;
    const btn = document.getElementById("micBtn");
    btn.className = micOn ? "ctrl-btn on" : "ctrl-btn off";
    btn.textContent = micOn ? "ðŸŽ¤" : "ðŸ”‡";
  });

  document.getElementById("camBtn").addEventListener("click", () => {
    if (camOn) { meeting.disableWebcam(); } else { meeting.enableWebcam(); }
    camOn = !camOn;
    const btn = document.getElementById("camBtn");
    btn.className = camOn ? "ctrl-btn on" : "ctrl-btn off";
    btn.textContent = camOn ? "ðŸ“·" : "ðŸ“·";
  });

  document.getElementById("leaveBtn").addEventListener("click", () => {
    meeting.leave();
  });

  // â”€â”€â”€ GO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 
  // document.body.addEventListener("click", () => {
  //   if (!meeting) startMeeting();
  // }, { once: true });
  startMeeting();

</script>
</body>
</html>
